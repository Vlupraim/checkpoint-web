@using Microsoft.AspNetCore.Authentication

@{
    // Verificar si la sesión es persistente
    var authProperties = await Context.AuthenticateAsync();
  var isPersistent = authProperties?.Properties?.IsPersistent ?? false;
}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>@ViewData["Title"] - Checkpoint Calidad</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/theme-minimal.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/checkpoint_web.styles.css" asp-append-version="true" />
</head>

<body data-authenticated="@(User.Identity?.IsAuthenticated == true ? "True" : "False")" data-persistent="@(isPersistent ? "True" : "False")">
    <!-- Header -->
    <header>
        <nav class="navbar navbar-expand-md navbar-light bg-white border-bottom box-shadow mb-0">
   <div class="container-fluid">
        <a class="navbar-brand me-3 d-flex align-items-center" href="/Calidad/ControlCalidad">
     <img src="~/images/logo-icon.png" alt="Logo Checkpoint" class="logo-mini me-1" />
    <img src="~/images/logo-text.png" alt="Texto Checkpoint" class="logo-text" />
       </a>

   <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNavbar"
     aria-controls="#topNavbar" aria-expanded="false" aria-label="Toggle navigation">
       <span class="navbar-toggler-icon"></span>
      </button>

         <div class="collapse navbar-collapse" id="topNavbar">
         <ul class="navbar-nav me-auto mb-2 mb-md-0">
  <li class="nav-item">
      <a class="nav-link" href="/Calidad/ControlCalidad">Inicio</a>
      </li>
  </ul>

  <form class="d-none d-md-flex mx-auto" method="get">
       <input class="form-control me-2 search-bar" type="search" placeholder="Buscar..." aria-label="Buscar" />
          <button class="btn btn-outline-secondary" type="submit">Buscar</button>
      </form>

  <ul class="navbar-nav ms-auto">
    @if (User.Identity?.IsAuthenticated == true)
      {
     @await Component.InvokeAsync("Notifications")
   <li class="nav-item dropdown">
           <a class="nav-link dropdown-toggle" href="#" id="userMenu" role="button"
    data-bs-toggle="dropdown" aria-expanded="false">
       Hola, @User.Identity.Name
        </a>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
  <li><a class="dropdown-item" href="/Calidad/ControlCalidad">
    ?? Revisar Lotes
       </a></li>
   @if (User.IsInRole("Administrador"))
    {
 <li><a class="dropdown-item" href="/Admin/Dashboard">
   ?? Panel Administrador
      </a></li>
    }
      @if (User.IsInRole("PersonalBodega"))
    {
   <li><a class="dropdown-item" href="/Bodega/Dashboard">
   ?? Panel Bodega
  </a></li>
   }
 <li><hr class="dropdown-divider" /></li>
      <li>
 <form method="post" asp-page="/Account/Logout" class="d-inline">
  @Html.AntiForgeryToken()
    <button type="submit" class="btn btn-link dropdown-item text-start">
       ?? Cerrar Sesión
     </button>
 </form>
    </li>
</ul>
          </li>
        }
     </ul>
       </div>
  </div>
 </nav>
    </header>

    <!-- Calidad Dashboard Layout with SPA Navigation -->
    <div class="container-fluid">
  <div class="row">
      <nav class="col-md-2 d-none d-md-block sidebar py-3">
      <div class="nav flex-column">

     <div class="sidebar-section-header">? CONTROL DE CALIDAD</div>
     <a class="nav-link active" href="#" data-url="/Calidad/ControlCalidad/Index" data-path="/Calidad/ControlCalidad">
   ?? Revisar Lotes
  </a>
    <a class="nav-link" href="#" data-url="/Calidad/Historial" data-path="/Calidad/Historial">
    ?? Historial Completo
</a>

   <div class="sidebar-section-header">?? REPORTES</div>
   <a class="nav-link" href="#" data-url="/Reportes/Index" data-path="/Reportes">
    ?? Dashboard Reportes
   </a>
<a class="nav-link" href="/Reportes/Movimientos" target="_blank">
       ?? Historial Movimientos
</a>
  <a class="nav-link" href="/Reportes/Tareas" target="_blank">
      ?? Reporte Tareas
</a>
        <a class="nav-link" href="/Admin/AuditLogs/Index" target="_blank">
   ?? Auditoría Sistema
    </a>
    </div>
   </nav>
 <main class="col-md-10 ms-sm-auto col-lg-10 px-md-4 py-3">
    <div id="calidadContent">
@RenderBody()
           </div>
  </main>
     </div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="~/js/site.js" asp-append-version="true"></script>

    <script>
   (function () {
     const mapping = {
'/Calidad/ControlCalidad': '/Calidad/ControlCalidad/Index',
       '/Calidad/Historial': '/Calidad/Historial',
  '/Reportes': '/Reportes/Index'
      };

  function loadUrl(url, replaceState) {
         fetch(url, {
 credentials: 'same-origin',
     headers: {
        'X-Requested-With': 'XMLHttpRequest'
            }
   })
         .then(function (resp) {
         if (!resp.ok) {
 console.error('HTTP error:', resp.status, resp.statusText);
     throw new Error('HTTP ' + resp.status);
   }
     return resp.text();
     })
  .then(function (html) {
      document.getElementById('calidadContent').innerHTML = html;
           if (replaceState) {
 history.replaceState({
         url: url
   }, '', location.pathname);
  }
   })
.catch(function (err) {
  console.error('Load error:', err);
document.getElementById('calidadContent').innerHTML =
       '<div class="alert alert-danger">Error al cargar el contenido: ' + err.message + '</div>';
         });
            }

          document.addEventListener('DOMContentLoaded', function () {
     // Click handlers for sidebar links
        document.querySelectorAll('.sidebar a[data-url]').forEach(function (a) {
     a.addEventListener('click', function (e) {
  e.preventDefault();

         // Update active state
  document.querySelectorAll('.sidebar a').forEach(function (link) {
   link.classList.remove('active');
         });
   a.classList.add('active');

      var url = a.getAttribute('data-url');
       var path = a.getAttribute('data-path') || url;

   fetch(url, {
  credentials: 'same-origin',
       headers: {
   'X-Requested-With': 'XMLHttpRequest'
     }
         })
    .then(function (resp) {
          if (!resp.ok) {
console.error('Navigation error - HTTP:', resp.status, resp.statusText);
      throw new Error('HTTP ' + resp.status);
   }
          return resp.text();
        })
          .then(function (html) {
    document.getElementById('calidadContent').innerHTML = html;
        history.pushState({
     url: url
  }, '', path);
        })
     .catch(function (err) {
           console.error('Navigation error:', err);
     document.getElementById('calidadContent').innerHTML =
        '<div class="alert alert-danger">Error al cargar el contenido: ' + err.message + '</div>';
      });
        });
  });

       // Handle browser back/forward
        window.addEventListener('popstate', function (event) {
 var state = event.state;
       if (state && state.url) {
  loadUrl(state.url, false);
 } else {
  var frag = mapping[location.pathname];
      if (frag) {
    loadUrl(frag, true);
  } else {
     window.location = location.pathname;
    }
        }
       });

       // Initial load: if not on ControlCalidad root, load mapped fragment
    var initial = location.pathname;
     if (initial && initial !== '/Calidad/ControlCalidad' && mapping[initial]) {
     loadUrl(mapping[initial], true);
       }
  });
        })();
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
