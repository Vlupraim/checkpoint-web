@page
@model checkpoint_web.Pages.Bodega.MovimientosModel
@{
    ViewData["Title"] = "Movimientos de Inventario";
    Layout = Request.Headers["X-Requested-With"] == "XMLHttpRequest" ? null : "/Pages/Shared/_BodegaLayout.cshtml";
}

<h2>Movimientos de Inventario</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Registrar Nuevo Movimiento</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Tipo de Movimiento</label>
                            <select asp-for="Tipo" class="form-select" required>
                                <option value="">Seleccionar...</option>
                                <option value="Entrada">Entrada</option>
                                <option value="Salida">Salida</option>
                                <option value="Ajuste">Ajuste</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Lote</label>
                            <select asp-for="LoteId" asp-items="Model.LotesDisponibles" class="form-select" required>
                                <option value="">Seleccionar Lote...</option>
                            </select>
                            <small class="text-muted">Solo lotes liberados con stock disponible</small>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Cantidad</label>
                            <input asp-for="Cantidad" type="number" class="form-control" step="0.01" required />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Observaciones</label>
                            <input asp-for="Observaciones" type="text" class="form-control" placeholder="Opcional" />
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">Registrar Movimiento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Historial de Movimientos Hoy</h5>
    </div>
    <div class="card-body">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Hora</th>
                    <th>Tipo</th>
                    <th>Producto</th>
                    <th>Lote</th>
                    <th>Cantidad</th>
                    <th>Usuario</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.MovimientosHoy.Any())
                {
                    @foreach (var mov in Model.MovimientosHoy)
                    {
                        <tr>
                            <td>@mov.Fecha.ToString("HH:mm")</td>
                            <td><span class="badge bg-primary">@mov.Tipo</span></td>
                            <td>@mov.Lote?.Producto?.Nombre</td>
                            <td><small>@mov.Lote?.CodigoLote</small></td>
                            <td><strong>@mov.Cantidad.ToString("N2")</strong></td>
                            <td>@(mov.UsuarioId ?? "-")</td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" class="text-center text-muted">No hay movimientos registrados hoy</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
