@page
@model checkpoint_web.Pages.Bodega.MovimientosModel
@{
    ViewData["Title"] = "Movimientos de Inventario";
    Layout = Request.Headers["X-Requested-With"] == "XMLHttpRequest" ? null : "/Pages/Shared/_BodegaLayout.cshtml";
}

<h2><i class="bi bi-arrow-left-right"></i> Movimientos de Inventario</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show">
        <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
        <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Registrar Nuevo Movimiento</h5>
            </div>
            <div class="card-body">
                <form method="post" id="movimientoForm">
                    @Html.AntiForgeryToken()
                    
                    <!-- Paso 1: Tipo de Movimiento -->
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label class="form-label fw-bold">1️⃣ Tipo de Movimiento *</label>
                            <div class="d-flex gap-3">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="Tipo" id="tipoEntrada" value="Entrada" required>
                                    <label class="form-check-label btn btn-outline-success" for="tipoEntrada" style="cursor:pointer; padding:10px 20px;">
                                        <i class="bi bi-box-arrow-in-down"></i> ✅ Entrada/Ingreso
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="Tipo" id="tipoSalida" value="Salida">
                                    <label class="form-check-label btn btn-outline-danger" for="tipoSalida" style="cursor:pointer; padding:10px 20px;">
                                        <i class="bi bi-box-arrow-up"></i> 📤 Salida
                                    </label>
                                </div>
                            </div>
                            <small class="form-text text-muted" id="tipoHelp">
                                Seleccione el tipo de operación. Para ajustes de inventario, use la sección <a href="/Bodega/Ajustes" class="text-decoration-none">⚖️ Ajustes</a>
                            </small>
                        </div>
                    </div>

                    <hr />

                    <!-- Paso 2: Selección de Lote -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-8">
                            <label asp-for="LoteId" class="form-label fw-bold">2️⃣ Lote *</label>
                            <select asp-for="LoteId" asp-items="Model.LotesDisponibles" class="form-select form-select-lg" id="loteSelect" required>
                                <option value="">-- Seleccione un Lote --</option>
                            </select>
                            <small class="form-text text-muted">
                                <i class="bi bi-info-circle"></i> Solo lotes liberados con stock disponible
                            </small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">4️⃣ Cantidad y Unidad *</label>
                            <div class="input-group input-group-lg">
                                <input asp-for="Cantidad" type="number" class="form-control" id="cantidadInput" step="0.01" min="0.01" placeholder="0.00" required />
                                <input type="text" class="form-control" id="unidadInput" name="Unidad" value="u" placeholder="Unidad" style="max-width: 100px;" required />
                            </div>
                            <small class="form-text text-muted">
                                <i class="bi bi-info-circle"></i> Valor: cantidad numérica | Unidad: kg, L, caja, etc.
                            </small>
                        </div>
                    </div>

                    <!-- Paso 3: Información de Stock (se muestra dinámicamente) -->
                    <div id="stockInfoContainer" style="display:none;">
                        <div class="alert alert-info border-start border-4 border-info">
                            <h6 class="alert-heading"><i class="bi bi-box-seam"></i> Stock Disponible del Lote Seleccionado</h6>
                            <div id="stockCards" class="row g-3 mt-2">
                                <!-- Se llenará dinámicamente con JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Paso 3: Ubicación -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-12">
                            <label asp-for="UbicacionId" class="form-label fw-bold">3️⃣ Ubicación *</label>
                            <select asp-for="UbicacionId" asp-items="Model.UbicacionesDisponibles" class="form-select form-select-lg" id="ubicacionSelect" required>
                                <option value="">-- Seleccione una Ubicación --</option>
                            </select>
                            <small class="form-text text-muted" id="ubicacionHelp">
                                <span id="ubicacionHelpEntrada" style="display:none;">
                                    <i class="bi bi-arrow-down-circle text-success"></i> Ubicación de <strong>destino</strong> donde se guardará el stock
                                </span>
                                <span id="ubicacionHelpSalida" style="display:none;">
                                    <i class="bi bi-arrow-up-circle text-danger"></i> Ubicación de <strong>origen</strong> donde se retirará el stock (debe tener stock disponible)
                                </span>
                            </small>
                            <span asp-validation-for="UbicacionId" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-12">
                            <label asp-for="Observaciones" class="form-label">Observaciones</label>
                            <textarea asp-for="Observaciones" class="form-control" rows="2" placeholder="Opcional (requerido para ajustes)"></textarea>
                            <small class="form-text text-muted" id="observacionesHelp">
                                <span id="obsHelpAjuste" style="display:none;">
                                    <i class="bi bi-exclamation-triangle text-warning"></i> <strong>Obligatorio para ajustes:</strong> Debe explicar el motivo del ajuste
                                </span>
                            </small>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-save"></i> Registrar Movimiento
                        </button>
                        <button type="reset" class="btn btn-secondary btn-lg">
                            <i class="bi bi-x-circle"></i> Limpiar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Historial de Movimientos Hoy</h5>
    </div>
    <div class="card-body">
        @if (Model.MovimientosHoy.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th><i class="bi bi-clock"></i> Hora</th>
                            <th><i class="bi bi-tag"></i> Tipo</th>
                            <th><i class="bi bi-box-seam"></i> Producto</th>
                            <th><i class="bi bi-upc"></i> Lote</th>
                            <th><i class="bi bi-geo-alt"></i> Ubicación</th>
                            <th class="text-end"><i class="bi bi-hash"></i> Cantidad</th>
                            <th><i class="bi bi-person"></i> Usuario</th>
                            <th><i class="bi bi-info-circle"></i> Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var mov in Model.MovimientosHoy)
                        {
                            <tr>
                                <td><small>@mov.Fecha.ToLocalTime().ToString("HH:mm:ss")</small></td>
                                <td>
                                    @{
                                        var tipoLower = (mov.Tipo ?? "").ToLower();
                                    }
                                    @switch (tipoLower)
                                    {
                                        case "ingreso":
                                        case "entrada":
                                            <span class="badge bg-success">✅ @mov.Tipo</span>
                                            break;
                                        case "salida":
                                            <span class="badge bg-danger">📤 @mov.Tipo</span>
                                            break;
                                        case "traslado":
                                            <span class="badge bg-info">🔄 @mov.Tipo</span>
                                            break;
                                        case "ajuste":
                                            <span class="badge bg-warning text-dark">⚖️ @mov.Tipo</span>
                                            break;
                                        case "devolucion":
                                        case "devolución":
                                            <span class="badge bg-primary">↩️ @mov.Tipo</span>
                                            break;
                                        default:
                                            <span class="badge bg-secondary">@mov.Tipo</span>
                                            break;
                                    }
                                </td>
                                <td>
                                    <strong>@(mov.Lote?.Producto?.Nombre ?? "-")</strong>
                                </td>
                                <td>
                                    <small class="text-muted">@(mov.Lote?.CodigoLote ?? "-")</small>
                                </td>
                                <td>
                                    <small>
                                        @if (mov.DestinoUbicacionId != null)
                                        {
                                            <span class="text-success">→ @(mov.DestinoUbicacion?.Codigo ?? "N/A")</span>
                                        }
                                        @if (mov.OrigenUbicacionId != null)
                                        {
                                            <span class="text-danger">← @(mov.OrigenUbicacion?.Codigo ?? "N/A")</span>
                                        }
                                    </small>
                                </td>
                                <td class="text-end">
                                    <strong>@mov.Cantidad.ToString("N2")</strong> @(mov.Unidad ?? "u")
                                </td>
                                <td><small>@(mov.UsuarioId != null && mov.UsuarioId.Length >= 8 ? mov.UsuarioId.Substring(0, 8) + "..." : mov.UsuarioId ?? "-")</small></td>
                                <td>
                                    @if (mov.Estado == "Completado")
                                    {
                                        <span class="badge bg-success">Completado</span>
                                    }
                                    else if (mov.Estado == "Pendiente")
                                    {
                                        <span class="badge bg-warning text-dark">Pendiente</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">@mov.Estado</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-info mb-0">
                <i class="bi bi-info-circle"></i> No hay movimientos registrados hoy
            </div>
        }
    </div>
    @if (Model.MovimientosHoy.Any())
    {
        <div class="card-footer text-muted">
            <small><i class="bi bi-calculator"></i> Total de movimientos hoy: <strong>@Model.MovimientosHoy.Count</strong></small>
        </div>
    }
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
    $(document).ready(function() {
        const tipoRadios = $('input[name="Tipo"]');
        const loteSelect = $('#loteSelect');
        const ubicacionSelect = $('#ubicacionSelect');
        const cantidadInput = $('#cantidadInput');
        const unidadInput = $('#unidadInput');
        const stockInfoContainer = $('#stockInfoContainer');
        const stockCards = $('#stockCards');
        const movimientoForm = $('#movimientoForm');
        
        let stockDisponiblePorUbicacion = {};
        
        // Validar antes de enviar formulario
        movimientoForm.on('submit', function(e) {
            const tipo = $('input[name="Tipo"]:checked').val();
            const ubicacionId = ubicacionSelect.val();
            const cantidad = parseFloat(cantidadInput.val());
            
            // Validar solo en salidas
            if (tipo && tipo.toLowerCase() === 'salida') {
                const stockDisponible = stockDisponiblePorUbicacion[ubicacionId] || 0;
                
                if (cantidad > stockDisponible) {
                    e.preventDefault();
                    alert(`❌ Stock Insuficiente\n\n` +
                          `Cantidad solicitada: ${cantidad.toFixed(2)}\n` +
                          `Stock disponible en ubicación: ${stockDisponible.toFixed(2)}\n\n` +
                          `Por favor, ajuste la cantidad o seleccione otra ubicación con stock suficiente.`);
                    cantidadInput.focus();
                    cantidadInput.addClass('is-invalid');
                    setTimeout(() => cantidadInput.removeClass('is-invalid'), 3000);
                    return false;
                }
            }
        });
        
        // Manejar cambio de tipo
        tipoRadios.on('change', function() {
            const tipo = $(this).val().toLowerCase();
            
            // Ocultar todos los helpers
            $('#ubicacionHelpEntrada, #ubicacionHelpSalida, #obsHelpAjuste').hide();
            
            // Mostrar helper correspondiente
            if (tipo === 'entrada') {
                $('#ubicacionHelpEntrada').show();
                stockInfoContainer.hide();
            } else if (tipo === 'salida') {
                $('#ubicacionHelpSalida').show();
                // Si hay lote seleccionado, cargar stock
                if (loteSelect.val()) {
                    cargarStockPorLote(loteSelect.val());
                }
            }
            
            // Cambiar color del label
            $('.form-check-label').removeClass('btn-outline-success btn-outline-danger active');
            $(this).next('label').addClass('active');
        });
        
        // Manejar cambio de lote
        loteSelect.on('change', async function() {
            const loteId = $(this).val();
            const tipo = $('input[name="Tipo"]:checked').val();
            
            if (!loteId) {
                stockInfoContainer.hide();
                unidadInput.val('u');
                stockDisponiblePorUbicacion = {};
                return;
            }
            
            // Extraer unidad del texto seleccionado
            const selectedText = $(this).find('option:selected').text();
            
            // Buscar patrones como: (100,00 kg disponibles) o (100,00 unidad disponibles)
            const unidadMatch = selectedText.match(/\(([\d,\.]+)\s+(\w+)\s+disponibles?\)/i);
            
            if (unidadMatch && unidadMatch[2]) {
                // Normalizar la unidad extraída
                let unidad = unidadMatch[2].toLowerCase();
                
                // Mapear variaciones comunes
                const unidadMap = {
                    'kg': 'kg',
                    'kilogramo': 'kg',
                    'kilogramos': 'kg',
                    'unidad': 'u',
                    'unidades': 'u',
                    'caja': 'caja',
                    'cajas': 'caja',
                    'litro': 'L',
                    'litros': 'L',
                    'l': 'L',
                    '500': '500',
                    'gramo': 'g',
                    'gramos': 'g',
                    'g': 'g'
                };
                
                unidad = unidadMap[unidad] || unidad;
                unidadInput.val(unidad);
            } else {
                // Fallback: buscar la unidad en el texto sin patrón específico
                if (selectedText.includes(' kg ')) unidadInput.val('kg');
                else if (selectedText.includes(' caja ')) unidadInput.val('caja');
                else if (selectedText.includes(' 500 ')) unidadInput.val('500');
                else if (selectedText.includes(' L ')) unidadInput.val('L');
                else if (selectedText.includes(' g ')) unidadInput.val('g');
                else unidadInput.val('u');
            }
            
            // Si es salida, cargar stock disponible
            if (tipo && tipo.toLowerCase() === 'salida') {
                await cargarStockPorLote(loteId);
            }
        });
        
        async function cargarStockPorLote(loteId) {
            try {
                const response = await fetch(`?handler=StockPorLote&loteId=${loteId}`);
                const data = await response.json();
                
                if (data.success && data.stocks && data.stocks.length > 0) {
                    stockCards.empty();
                    stockDisponiblePorUbicacion = {};
                    
                    data.stocks.forEach(stock => {
                        // Guardar stock disponible por ubicación
                        stockDisponiblePorUbicacion[stock.ubicacionId] = stock.cantidad;
                        
                        const card = `
                            <div class="col-md-3">
                                <div class="card border-info">
                                    <div class="card-body p-3">
                                        <h6 class="card-title text-info mb-1">
                                            <i class="bi bi-geo-alt-fill"></i> ${stock.ubicacionCodigo}
                                        </h6>
                                        <p class="card-text mb-0">
                                            <small class="text-muted">${stock.sedeNombre}</small><br/>
                                            <strong class="text-info">${stock.cantidad.toFixed(2)} ${stock.unidad}</strong>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                        stockCards.append(card);
                    });
                    
                    stockInfoContainer.show();
                } else {
                    stockCards.html('<div class="col-12"><div class="alert alert-warning mb-0">No hay stock disponible para este lote</div></div>');
                    stockInfoContainer.show();
                    stockDisponiblePorUbicacion = {};
                }
            } catch (error) {
                console.error('Error al cargar stock:', error);
            }
        }
        
        // Validar cantidad en tiempo real cuando cambia ubicación (solo en salida)
        ubicacionSelect.on('change', function() {
            const tipo = $('input[name="Tipo"]:checked').val();
            if (tipo && tipo.toLowerCase() === 'salida') {
                const ubicacionId = $(this).val();
                const cantidad = parseFloat(cantidadInput.val()) || 0;
                const stockDisponible = stockDisponiblePorUbicacion[ubicacionId] || 0;
                
                if (cantidad > stockDisponible && stockDisponible > 0) {
                    cantidadInput.addClass('is-invalid');
                    setTimeout(() => cantidadInput.removeClass('is-invalid'), 2000);
                }
            }
        });
        
        // Validar cantidad en tiempo real
        cantidadInput.on('input', function() {
            const tipo = $('input[name="Tipo"]:checked').val();
            if (tipo && tipo.toLowerCase() === 'salida') {
                const ubicacionId = ubicacionSelect.val();
                const cantidad = parseFloat($(this).val()) || 0;
                const stockDisponible = stockDisponiblePorUbicacion[ubicacionId] || 0;
                
                if (cantidad > stockDisponible && stockDisponible > 0) {
                    $(this).addClass('is-invalid');
                } else {
                    $(this).removeClass('is-invalid');
                }
            }
        });
    });
    </script>
}
