@page
@model checkpoint_web.Pages.Bodega.Ajustes.IndexModel
@{
  ViewData["Title"] = "Ajustes de Inventario";
    Layout = "/Pages/Shared/_Layout.cshtml";
}

<h2>?? Ajustes de Inventario</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show">
 @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
 </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
 @TempData["ErrorMessage"]
   <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Ajustes Pendientes de Aprobacion -->
<div class="card mb-4">
    <div class="card-header bg-warning">
     <h5 class="mb-0">? Pendientes de Aprobaci&oacute;n (@Model.AjustesPendientes.Count())</h5>
    </div>
 <div class="card-body">
   @if (Model.AjustesPendientes.Any())
  {
     <div class="table-responsive">
      <table class="table table-hover">
        <thead>
  <tr>
 <th>Fecha</th>
       <th>Lote</th>
    <th>Ubicaci&oacute;n</th>
         <th>Cantidad</th>
     <th>Tipo Ajuste</th>
    <th>Motivo</th>
         <th>Solicitado por</th>
    <th>Acciones</th>
     </tr>
</thead>
       <tbody>
       @foreach (var ajuste in Model.AjustesPendientes)
     {
         var esIncremento = ajuste.DestinoUbicacionId.HasValue;
 <tr>
     <td>@ajuste.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
 <td>
 @if (ajuste.Lote?.Producto != null)
      {
   <strong>@ajuste.Lote.Producto.Nombre</strong><br/>
  <small class="text-muted">@ajuste.Lote.CodigoLote</small>
      }
      </td>
   <td>@((esIncremento ? ajuste.DestinoUbicacion?.Codigo : ajuste.OrigenUbicacion?.Codigo) ?? "-")</td>
<td>
         <span class="badge @(esIncremento ? "bg-success" : "bg-danger")">
      @(esIncremento ? "+" : "-")@ajuste.Cantidad
</span>
   </td>
 <td>
      @if (esIncremento)
   {
    <span class="badge bg-success">Incremento</span>
     }
    else
 {
     <span class="badge bg-danger">Decremento</span>
    }
       </td>
       <td><small>@ajuste.Motivo</small></td>
  <td><small>@ajuste.UsuarioId</small></td>
   <td>
       @if (User.IsInRole("Administrador"))
   {
 <form method="post" asp-page-handler="Aprobar" asp-route-id="@ajuste.Id" class="d-inline">
 <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Â¿Aprobar este ajuste?');">
   ? Aprobar
</button>
       </form>
     }
   else
       {
  <span class="text-muted">Esperando aprobaci&oacute;n</span>
    }
 </td>
         </tr>
        }
 </tbody>
</table>
   </div>
        }
 else
  {
 <div class="alert alert-info">No hay ajustes pendientes de aprobaci&oacute;n</div>
  }
    </div>
</div>

<!-- Ajustes Aprobados Recientes -->
<div class="card">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">? Ajustes Aprobados (&Uacute;ltimos 20)</h5>
    </div>
 <div class="card-body">
  @if (Model.AjustesAprobados.Any())
        {
   <div class="table-responsive">
        <table class="table table-sm">
   <thead>
       <tr>
    <th>Fecha</th>
  <th>Lote</th>
    <th>Cantidad</th>
 <th>Motivo</th>
  <th>Aprobado por</th>
 </tr>
    </thead>
         <tbody>
      @foreach (var ajuste in Model.AjustesAprobados)
      {
    var esIncremento = ajuste.DestinoUbicacionId.HasValue;
    <tr>
       <td>@ajuste.FechaAprobacion?.ToString("dd/MM/yyyy")</td>
   <td>@ajuste.Lote?.CodigoLote</td>
     <td>
     <span class="badge @(esIncremento ? "bg-success" : "bg-danger")">
        @(esIncremento ? "+" : "-")@ajuste.Cantidad
   </span>
          </td>
       <td><small>@ajuste.Motivo</small></td>
     <td><small>@ajuste.AprobadoPor</small></td>
    </tr>
       }
        </tbody>
       </table>
        </div>
 }
else
 {
 <div class="alert alert-info">No hay ajustes aprobados recientes</div>
 }
    </div>
</div>
