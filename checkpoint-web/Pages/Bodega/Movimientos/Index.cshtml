@page
@model checkpoint_web.Pages.Bodega.Movimientos.IndexModel
@{
    ViewData["Title"] = "Movimientos de Inventario";
    Layout = "/Pages/Shared/_Layout.cshtml";
}

<h2>?? Movimientos de Inventario</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show">
        @TempData["SuccessMessage"]
 <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Acciones Rápidas -->
<div class="btn-group mb-4" role="group">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#trasladoModal">
 ?? Nuevo Traslado
 </button>
    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#salidaModal">
  ?? Nueva Salida
    </button>
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#devolucionModal">
?? Nueva Devolución
    </button>
</div>

<!-- Filtros -->
<div class="btn-group mb-3" role="group">
    <a asp-page="Index" class="btn @(string.IsNullOrEmpty(Model.FiltroTipo) ? "btn-primary" : "btn-outline-primary")">Todos</a>
 <a asp-page="Index" asp-route-tipo="Traslado" class="btn @(Model.FiltroTipo == "Traslado" ? "btn-primary" : "btn-outline-primary")">Traslados</a>
    <a asp-page="Index" asp-route-tipo="Salida" class="btn @(Model.FiltroTipo == "Salida" ? "btn-primary" : "btn-outline-primary")">Salidas</a>
    <a asp-page="Index" asp-route-tipo="Devolucion" class="btn @(Model.FiltroTipo == "Devolucion" ? "btn-primary" : "btn-outline-primary")">Devoluciones</a>
</div>

<!-- Tabla -->
<div class="card">
    <div class="card-body">
 @if (Model.Movimientos.Any())
  {
 <div class="table-responsive">
<table class="table table-hover table-sm">
<thead>
      <tr>
      <th>Fecha</th>
<th>Tipo</th>
      <th>Lote</th>
    <th>Origen</th>
   <th>Destino</th>
      <th>Cantidad</th>
 <th>Usuario</th>
     <th>Estado</th>
   </tr>
 </thead>
     <tbody>
      @foreach (var mov in Model.Movimientos)
    {
  var tipoClass = mov.Tipo switch {
   "Ingreso" => "badge bg-success",
"Traslado" => "badge bg-primary",
"Salida" => "badge bg-danger",
 "Devolucion" => "badge bg-warning",
  "Ajuste" => "badge bg-info",
    _ => "badge bg-secondary"
   };
     <tr>
      <td>@mov.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
<td><span class="@tipoClass">@mov.Tipo</span></td>
  <td>
    @if (mov.Lote?.Producto != null)
       {
<strong>@mov.Lote.Producto.Nombre</strong><br/>
      <small class="text-muted">@mov.Lote.CodigoLote</small>
   }
 </td>
   <td>@(mov.OrigenUbicacion?.Codigo ?? "-")</td>
   <td>@(mov.DestinoUbicacion?.Codigo ?? mov.Cliente?.Nombre ?? "-")</td>
<td>@mov.Cantidad @mov.Unidad</td>
       <td><small>@mov.UsuarioId</small></td>
<td><span class="badge @(mov.Estado == "Completado" ? "bg-success" : "bg-warning")">@mov.Estado</span></td>
</tr>
   }
 </tbody>
    </table>
   </div>
  }
        else
 {
       <div class="alert alert-info">No hay movimientos registrados.</div>
     }
 </div>
</div>

<!-- Modal Traslado -->
<div class="modal fade" id="trasladoModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
 <form method="post" asp-page-handler="Traslado">
<div class="modal-header">
<h5>?? Nuevo Traslado</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
  </div>
<div class="modal-body">
        <div class="mb-3">
 <label asp-for="Traslado.LoteId">Lote</label>
      <select asp-for="Traslado.LoteId" asp-items="Model.LotesSelectList" class="form-select" required></select>
       </div>
  <div class="mb-3">
     <label asp-for="Traslado.OrigenUbicacionId">Ubicación Origen</label>
     <select asp-for="Traslado.OrigenUbicacionId" asp-items="Model.UbicacionesSelectList" class="form-select" required></select>
   </div>
<div class="mb-3">
    <label asp-for="Traslado.DestinoUbicacionId">Ubicación Destino</label>
   <select asp-for="Traslado.DestinoUbicacionId" asp-items="Model.UbicacionesSelectList" class="form-select" required></select>
 </div>
    <div class="mb-3">
  <label asp-for="Traslado.Cantidad">Cantidad</label>
   <input asp-for="Traslado.Cantidad" type="number" step="0.001" class="form-control" required />
      </div>
   <div class="mb-3">
   <label asp-for="Traslado.Motivo">Motivo (opcional)</label>
  <input asp-for="Traslado.Motivo" class="form-control" />
    </div>
    </div>
    <div class="modal-footer">
     <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
     <button type="submit" class="btn btn-primary">Registrar Traslado</button>
    </div>
 </form>
  </div>
    </div>
</div>

<!-- Modal Salida -->
<div class="modal fade" id="salidaModal" tabindex="-1">
    <div class="modal-dialog">
 <div class="modal-content">
  <form method="post" asp-page-handler="Salida">
<div class="modal-header">
<h5>?? Nueva Salida</h5>
       <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
 </div>
 <div class="modal-body">
       <div class="mb-3">
  <label asp-for="Salida.LoteId">Lote</label>
     <select asp-for="Salida.LoteId" asp-items="Model.LotesSelectList" class="form-select" required></select>
 </div>
       <div class="mb-3">
<label asp-for="Salida.UbicacionId">Ubicación</label>
      <select asp-for="Salida.UbicacionId" asp-items="Model.UbicacionesSelectList" class="form-select" required></select>
     </div>
    <div class="mb-3">
     <label asp-for="Salida.Cantidad">Cantidad</label>
<input asp-for="Salida.Cantidad" type="number" step="0.001" class="form-control" required />
 </div>
      <div class="mb-3">
<label asp-for="Salida.ClienteId">Cliente (opcional)</label>
   <select asp-for="Salida.ClienteId" asp-items="Model.ClientesSelectList" class="form-select">
<option value="">-- Ninguno --</option>
</select>
  </div>
     <div class="mb-3">
  <label asp-for="Salida.Motivo">Motivo</label>
<input asp-for="Salida.Motivo" class="form-control" />
      </div>
 </div>
     <div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
<button type="submit" class="btn btn-danger">Registrar Salida</button>
  </div>
      </form>
  </div>
 </div>
</div>

<!-- Modal Devolución -->
<div class="modal fade" id="devolucionModal" tabindex="-1">
 <div class="modal-dialog">
   <div class="modal-content">
    <form method="post" asp-page-handler="Devolucion">
      <div class="modal-header">
<h5>?? Nueva Devolución</h5>
 <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
 </div>
      <div class="modal-body">
 <div class="mb-3">
    <label asp-for="Devolucion.LoteId">Lote</label>
     <select asp-for="Devolucion.LoteId" asp-items="Model.LotesSelectList" class="form-select" required></select>
     </div>
 <div class="mb-3">
 <label asp-for="Devolucion.UbicacionId">Ubicación Destino</label>
    <select asp-for="Devolucion.UbicacionId" asp-items="Model.UbicacionesSelectList" class="form-select" required></select>
   </div>
  <div class="mb-3">
      <label asp-for="Devolucion.Cantidad">Cantidad</label>
  <input asp-for="Devolucion.Cantidad" type="number" step="0.001" class="form-control" required />
      </div>
  <div class="mb-3">
      <label asp-for="Devolucion.Motivo">Motivo</label>
  <input asp-for="Devolucion.Motivo" class="form-control" required />
 </div>
  </div>
<div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
  <button type="submit" class="btn btn-success">Registrar Devolución</button>
  </div>
  </form>
 </div>
 </div>
</div>
