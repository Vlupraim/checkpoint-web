@page
@model checkpoint_web.Pages.Bodega.TrasladosModel
@{
    ViewData["Title"] = "Traslados entre Ubicaciones";
    Layout = Request.Headers["X-Requested-With"] == "XMLHttpRequest" ? null : "/Pages/Shared/_BodegaLayout.cshtml";
}

<h2><i class="bi bi-arrow-left-right"></i> Traslados entre Ubicaciones</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show">
        <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
        <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-arrow-left-right"></i> Registrar Traslado</h5>
            </div>
            <div class="card-body">
                <form method="post" id="trasladoForm">
                    @Html.AntiForgeryToken()
                    
                    <!-- Paso 1: Selección de Lote -->
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label asp-for="LoteId" class="form-label fw-bold">1️⃣ Seleccione el Lote a Trasladar *</label>
                            <select asp-for="LoteId" asp-items="Model.LotesDisponibles" class="form-select form-select-lg" id="loteSelect" required>
                                <option value="">-- Seleccione un Lote --</option>
                            </select>
                            <small class="form-text text-muted">
                                <i class="bi bi-info-circle"></i> Solo lotes liberados con stock disponible
                            </small>
                            <span asp-validation-for="LoteId" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Información de Stock Disponible -->
                    <div id="stockInfoContainer" style="display:none;">
                        <div class="alert alert-info border-start border-4 border-info">
                            <h6 class="alert-heading"><i class="bi bi-box-seam"></i> Stock Disponible por Ubicación</h6>
                            <div id="stockCards" class="row g-3 mt-2">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>

                    <hr />

                    <!-- Paso 2: Origen y Destino -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label asp-for="OrigenId" class="form-label fw-bold">
                                2️⃣ Ubicación de Origen *
                                <span class="badge bg-danger ms-2">📤 Salida</span>
                            </label>
                            <select asp-for="OrigenId" asp-items="Model.UbicacionesOrigen" class="form-select form-select-lg" id="origenSelect" required>
                                <option value="">-- Seleccione Ubicación de Origen --</option>
                            </select>
                            <small class="form-text text-muted">
                                <i class="bi bi-arrow-up-circle text-danger"></i> Desde dónde se retirará el stock
                            </small>
                            <span asp-validation-for="OrigenId" class="text-danger"></span>
                            
                            <div id="stockOrigenInfo" class="mt-2" style="display:none;">
                                <div class="alert alert-warning mb-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="bi bi-box"></i> <strong>Stock en esta ubicación:</strong>
                                        </div>
                                        <div class="text-end">
                                            <strong class="fs-5" id="stockOrigenCantidad">0</strong> <span id="stockOrigenUnidad">u</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="DestinoId" class="form-label fw-bold">
                                3️⃣ Ubicación de Destino *
                                <span class="badge bg-success ms-2">📥 Entrada</span>
                            </label>
                            <select asp-for="DestinoId" asp-items="Model.UbicacionesDestino" class="form-select form-select-lg" id="destinoSelect" required>
                                <option value="">-- Seleccione Ubicación de Destino --</option>
                            </select>
                            <small class="form-text text-muted">
                                <i class="bi bi-arrow-down-circle text-success"></i> Hacia dónde se moverá el stock
                            </small>
                            <span asp-validation-for="DestinoId" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Paso 4: Cantidad y Motivo -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label asp-for="Cantidad" class="form-label fw-bold">4️⃣ Cantidad a Trasladar *</label>
                            <div class="input-group input-group-lg">
                                <input asp-for="Cantidad" type="number" class="form-control" id="cantidadInput" step="0.01" min="0.01" placeholder="0.00" required />
                                <span class="input-group-text" id="unidadText">u</span>
                            </div>
                            <span asp-validation-for="Cantidad" class="text-danger"></span>
                            
                            <!-- Información de stock en tiempo real -->
                            <div id="stockDisponibleInfo" class="mt-2" style="display:none;">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-box-seam text-info"></i>
                                    <small class="text-muted">
                                        <strong>Stock disponible en <span id="ubicacionNombreInfo">-</span>:</strong>
                                    </small>
                                    <strong class="text-info" id="stockCantidadInfo">0</strong>
                                    <small class="text-muted" id="stockUnidadInfo">u</small>
                                </div>
                            </div>
                            
                            <!-- Alerta si no hay stock -->
                            <div id="sinStockAlert" class="mt-2" style="display:none;">
                                <div class="alert alert-danger mb-0 py-2">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <small><strong>Sin stock en esta ubicación.</strong> Seleccione otra ubicación de origen.</small>
                                </div>
                            </div>
                            
                            <!-- Alerta si cantidad excede stock -->
                            <div id="excedeStockAlert" class="mt-2" style="display:none;">
                                <div class="alert alert-warning mb-0 py-2">
                                    <i class="bi bi-exclamation-circle"></i>
                                    <small><strong>Cantidad supera el stock disponible.</strong></small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-8">
                            <label asp-for="Motivo" class="form-label">Motivo del Traslado (Opcional)</label>
                            <input asp-for="Motivo" type="text" class="form-control form-control-lg" placeholder="Ej: Reorganización de bodega, reubicación..." />
                        </div>
                    </div>

                    <!-- Visualización del Traslado -->
                    <div id="trasladoVisualizacion" class="alert alert-light border" style="display:none;">
                        <div class="row align-items-center">
                            <div class="col-md-5 text-center">
                                <div class="card bg-danger bg-opacity-10 border-danger">
                                    <div class="card-body">
                                        <h6 class="text-danger"><i class="bi bi-geo-alt-fill"></i> Origen</h6>
                                        <p class="mb-0 fw-bold" id="origenNombre">-</p>
                                        <small id="origenStock" class="text-muted">Stock: -</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <i class="bi bi-arrow-right" style="font-size: 3rem; color: #0d6efd;"></i>
                                <p class="fw-bold text-primary" id="cantidadTraslado">0 u</p>
                            </div>
                            <div class="col-md-5 text-center">
                                <div class="card bg-success bg-opacity-10 border-success">
                                    <div class="card-body">
                                        <h6 class="text-success"><i class="bi bi-geo-alt-fill"></i> Destino</h6>
                                        <p class="mb-0 fw-bold" id="destinoNombre">-</p>
                                        <small class="text-muted">Nueva ubicación</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-info btn-lg text-white">
                            <i class="bi bi-arrow-left-right"></i> Ejecutar Traslado
                        </button>
                        <button type="reset" class="btn btn-secondary btn-lg">
                            <i class="bi bi-x-circle"></i> Limpiar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Traslados Recientes</h5>
    </div>
    <div class="card-body">
        @if (Model.TrasladosRecientes.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th><i class="bi bi-clock"></i> Fecha</th>
                            <th><i class="bi bi-box-seam"></i> Lote</th>
                            <th><i class="bi bi-geo-alt text-danger"></i> Origen</th>
                            <th></th>
                            <th><i class="bi bi-geo-alt text-success"></i> Destino</th>
                            <th class="text-end"><i class="bi bi-hash"></i> Cantidad</th>
                            <th><i class="bi bi-person"></i> Usuario</th>
                            <th><i class="bi bi-info-circle"></i> Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var tras in Model.TrasladosRecientes)
                        {
                            <tr>
                                <td><small>@tras.Fecha.ToLocalTime().ToString("dd/MM HH:mm")</small></td>
                                <td>
                                    <strong>@(tras.Lote?.Producto?.Nombre ?? "-")</strong><br/>
                                    <small class="text-muted">@(tras.Lote?.CodigoLote ?? "-")</small>
                                </td>
                                <td><span class="badge bg-danger">@(tras.OrigenUbicacion?.Codigo ?? "-")</span></td>
                                <td class="text-center"><i class="bi bi-arrow-right text-primary"></i></td>
                                <td><span class="badge bg-success">@(tras.DestinoUbicacion?.Codigo ?? "-")</span></td>
                                <td class="text-end"><strong>@tras.Cantidad.ToString("N2")</strong> @(tras.Unidad ?? "u")</td>
                                <td><small>@(tras.UsuarioId != null && tras.UsuarioId.Length >= 8 ? tras.UsuarioId.Substring(0, 8) + "..." : tras.UsuarioId ?? "-")</small></td>
                                <td>
                                    @if (tras.Estado == "Completado")
                                    {
                                        <span class="badge bg-success">Completado</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">@tras.Estado</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-info mb-0">
                <i class="bi bi-info-circle"></i> No hay traslados registrados
            </div>
        }
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
    $(document).ready(function() {
        const loteSelect = $('#loteSelect');
        const origenSelect = $('#origenSelect');
        const destinoSelect = $('#destinoSelect');
        const cantidadInput = $('#cantidadInput');
        const stockInfoContainer = $('#stockInfoContainer');
        const stockCards = $('#stockCards');
        const stockOrigenInfo = $('#stockOrigenInfo');
        const trasladoVisualizacion = $('#trasladoVisualizacion');
        const unidadText = $('#unidadText');
        
        // Elementos nuevos para stock en tiempo real
        const stockDisponibleInfo = $('#stockDisponibleInfo');
        const sinStockAlert = $('#sinStockAlert');
        const excedeStockAlert = $('#excedeStockAlert');
        const stockCantidadInfo = $('#stockCantidadInfo');
        const stockUnidadInfo = $('#stockUnidadInfo');
        const ubicacionNombreInfo = $('#ubicacionNombreInfo');
        
        let stocksDisponibles = {};
        let unidadProducto = 'u';
        let stockActualUbicacion = 0;
        
        // Cargar stock cuando se selecciona lote
        loteSelect.on('change', async function() {
            const loteId = $(this).val();
            
            if (!loteId) {
                stockInfoContainer.hide();
                stockOrigenInfo.hide();
                trasladoVisualizacion.hide();
                resetStockInfo();
                return;
            }
            
            // Extraer unidad
            const selectedText = $(this).find('option:selected').text();
            const unidadMatch = selectedText.match(/\(([\d,.]+ (\w+))/);
            if (unidadMatch) {
                unidadProducto = unidadMatch[2];
                unidadText.text(unidadProducto);
                stockUnidadInfo.text(unidadProducto);
            }
            
            // Cargar stock disponible por ubicación
            try {
                const response = await fetch(`/Bodega/Movimientos?handler=StockPorLote&loteId=${loteId}`);
                const data = await response.json();
                
                if (data.success && data.stocks && data.stocks.length > 0) {
                    stocksDisponibles = {};
                    stockCards.empty();
                    
                    data.stocks.forEach(stock => {
                        stocksDisponibles[stock.ubicacionId] = stock;
                        
                        const card = `
                            <div class="col-md-3">
                                <div class="card border-info">
                                    <div class="card-body p-3">
                                        <h6 class="card-title text-info mb-1">
                                            <i class="bi bi-geo-alt-fill"></i> ${stock.ubicacionCodigo}
                                        </h6>
                                        <p class="card-text mb-0">
                                            <small class="text-muted">${stock.sedeNombre}</small><br/>
                                            <strong class="text-info">${stock.cantidad.toFixed(2)} ${stock.unidad}</strong>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                        stockCards.append(card);
                    });
                    
                    stockInfoContainer.show();
                    
                    // Si ya hay ubicación seleccionada, actualizar info
                    const origenId = origenSelect.val();
                    if (origenId) {
                        actualizarStockInfo(origenId);
                    }
                } else {
                    stockCards.html('<div class="col-12"><div class="alert alert-warning mb-0">No hay stock disponible</div></div>');
                    stockInfoContainer.show();
                    resetStockInfo();
                }
            } catch (error) {
                console.error('Error al cargar stock:', error);
            }
        });
        
        // Actualizar info de origen cuando se selecciona
        origenSelect.on('change', async function() {
            const origenId = $(this).val();
            const loteId = loteSelect.val();
            
            if (!origenId || !loteId) {
                stockOrigenInfo.hide();
                resetStockInfo();
                return;
            }
            
            // Obtener stock específico de esta ubicación
            try {
                const response = await fetch(`?handler=StockPorLoteYUbicacion&loteId=${loteId}&ubicacionId=${origenId}`);
                const data = await response.json();
                
                if (data.success) {
                    stockActualUbicacion = data.cantidad;
                    
                    $('#stockOrigenCantidad').text(data.cantidad.toFixed(2));
                    $('#stockOrigenUnidad').text(data.unidad);
                    $('#origenNombre').text($(this).find('option:selected').text());
                    $('#origenStock').text(`Stock: ${data.cantidad.toFixed(2)} ${data.unidad}`);
                    stockOrigenInfo.removeClass('alert-danger').addClass('alert-warning').show();
                    
                    // Mostrar info en tiempo real debajo de cantidad
                    ubicacionNombreInfo.text($(this).find('option:selected').text().split(' - ')[1] || 'ubicación seleccionada');
                    stockCantidadInfo.text(data.cantidad.toFixed(2));
                    stockUnidadInfo.text(data.unidad);
                    stockDisponibleInfo.show();
                    sinStockAlert.hide();
                    
                    // Validar cantidad actual
                    validarCantidad();
                } else {
                    // Sin stock en esta ubicación
                    stockActualUbicacion = 0;
                    stockOrigenInfo.removeClass('alert-warning').addClass('alert-danger').show();
                    $('#stockOrigenCantidad').html('<span class="text-danger">0 (Sin stock)</span>');
                    $('#stockOrigenUnidad').text(unidadProducto);
                    
                    // Mostrar alerta de sin stock
                    stockDisponibleInfo.hide();
                    sinStockAlert.show();
                    excedeStockAlert.hide();
                }
                
                actualizarVisualizacion();
            } catch (error) {
                console.error('Error:', error);
            }
        });
        
        // Validar cantidad en tiempo real
        cantidadInput.on('input', function() {
            validarCantidad();
            actualizarVisualizacion();
        });
        
        function validarCantidad() {
            const cantidadSolicitada = parseFloat(cantidadInput.val() || 0);
            
            if (stockActualUbicacion === 0) {
                // Sin stock
                cantidadInput.addClass('is-invalid');
                sinStockAlert.show();
                excedeStockAlert.hide();
                stockDisponibleInfo.hide();
                return false;
            }
            
            if (cantidadSolicitada > stockActualUbicacion) {
                // Excede stock
                cantidadInput.addClass('is-invalid');
                stockOrigenInfo.removeClass('alert-warning').addClass('alert-danger');
                excedeStockAlert.show();
                stockDisponibleInfo.show();
                sinStockAlert.hide();
                return false;
            }
            
            // Cantidad válida
            cantidadInput.removeClass('is-invalid');
            stockOrigenInfo.removeClass('alert-danger').addClass('alert-warning');
            excedeStockAlert.hide();
            sinStockAlert.hide();
            stockDisponibleInfo.show();
            return true;
        }
        
        function resetStockInfo() {
            stockDisponibleInfo.hide();
            sinStockAlert.hide();
            excedeStockAlert.hide();
            stockActualUbicacion = 0;
        }
        
        function actualizarStockInfo(origenId) {
            if (stocksDisponibles[origenId]) {
                const stock = stocksDisponibles[origenId];
                stockActualUbicacion = stock.cantidad;
                ubicacionNombreInfo.text(stock.ubicacionCodigo);
                stockCantidadInfo.text(stock.cantidad.toFixed(2));
                stockUnidadInfo.text(stock.unidad);
                stockDisponibleInfo.show();
                validarCantidad();
            }
        }
        
        // Actualizar visualización
        destinoSelect.on('change', actualizarVisualizacion);
        
        function actualizarVisualizacion() {
            const origenId = origenSelect.val();
            const destinoId = destinoSelect.val();
            const cantidad = cantidadInput.val();
            
            if (origenId && destinoId && cantidad > 0) {
                $('#destinoNombre').text(destinoSelect.find('option:selected').text());
                $('#cantidadTraslado').text(`${parseFloat(cantidad).toFixed(2)} ${unidadText.text()}`);
                trasladoVisualizacion.show();
            } else {
                trasladoVisualizacion.hide();
            }
        }
    });
    </script>
}
