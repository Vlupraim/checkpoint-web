@page
@model checkpoint_web.Pages.Calidad.HistorialModel
@{
 ViewData["Title"] = "Historial Completo de Revisiones";
    Layout = Request.Headers["X-Requested-With"] == "XMLHttpRequest" ? null : "/Pages/Shared/_CalidadLayout.cshtml";
}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Historial Completo de Revisiones</h2>
    <div>
  <span class="badge bg-success me-2">Aprobados: @Model.Estadisticas.GetValueOrDefault("LotesAprobados", 0)</span>
        <span class="badge bg-danger me-2">Rechazados: @Model.Estadisticas.GetValueOrDefault("LotesRechazados", 0)</span>
  <span class="badge bg-dark">Bloqueados: @Model.Estadisticas.GetValueOrDefault("LotesBloqueados", 0)</span>
    </div>
</div>

<!-- Filtros Rápidos con Tabs -->
<ul class="nav nav-tabs mb-3" id="historialTabs" role="tablist">
    <li class="nav-item" role="presentation">
     <button class="nav-link active" id="tab-todos" data-bs-toggle="tab" data-bs-target="#todos" type="button">
   Todos (@Model.Historial.Count())
        </button>
    </li>
 <li class="nav-item" role="presentation">
<button class="nav-link" id="tab-aprobados" data-bs-toggle="tab" data-bs-target="#aprobados" type="button">
     ✅ Aprobados (@Model.Historial.Count(h => h.Estado == "Aprobado"))
 </button>
    </li>
    <li class="nav-item" role="presentation">
  <button class="nav-link" id="tab-rechazados" data-bs-toggle="tab" data-bs-target="#rechazados" type="button">
 ❌ Rechazados (@Model.Historial.Count(h => h.Estado == "Rechazado"))
 </button>
    </li>
    <li class="nav-item" role="presentation">
     <button class="nav-link" id="tab-bloqueados" data-bs-toggle="tab" data-bs-target="#bloqueados" type="button">
   🔒 Bloqueados (@Model.Historial.Count(h => h.Estado == "Bloqueado"))
 </button>
    </li>
</ul>

<!-- Contenido de Tabs -->
<div class="tab-content" id="historialTabsContent">
    <!-- Tab Todos -->
  <div class="tab-pane fade show active" id="todos" role="tabpanel">
  <div class="card">
    <div class="card-header">
     <h5 class="mb-0">Todas las Revisiones</h5>
   </div>
      <div class="card-body">
          @if (Model.Historial.Any())
          {
   <div class="table-responsive">
  <table class="table table-striped table-hover">
       <thead>
        <tr>
     <th>Fecha Revisión</th>
   <th>Código Lote</th>
     <th>Producto</th>
       <th>Decisión</th>
  <th>Observaciones</th>
     <th>Revisado Por</th>
       </tr>
     </thead>
  <tbody>
            @foreach (var rev in Model.Historial)
            {
                var estadoClass = rev.Estado switch
                {
                    "Aprobado" => "badge bg-success",
                    "Rechazado" => "badge bg-danger",
                    "Bloqueado" => "badge bg-dark",
                    _ => "badge bg-secondary"
                };
        <tr>
            <td>@rev.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
            <td><strong>@(rev.Lote?.CodigoLote ?? "N/A")</strong></td>
            <td>@(rev.Lote?.Producto?.Nombre ?? "N/A")</td>
            <td><span class="@estadoClass">@rev.Estado</span></td>
            <td><small>@(rev.Observacion ?? "-")</small></td>
            <td><small>@(rev.UsuarioId ?? "Sistema")</small></td>
        </tr>
            }
     </tbody>
 </table>
    </div>
          }
          else
          {
        <tr>
     <td colspan="6" class="text-center text-muted py-4">
    <p>No hay revisiones registradas</p>
 <small>Las decisiones de calidad aparecerán aquí</small>
  </td>
      </tr>
          }
    </div>
  </div>
    </div>

    <!-- Tab Aprobados -->
    <div class="tab-pane fade" id="aprobados" role="tabpanel">
     <div class="card border-success">
   <div class="card-header bg-success text-white">
  <h5 class="mb-0">Lotes Aprobados (Liberados)</h5>
    </div>
        <div class="card-body">
            @{
                var aprobados = Model.Historial.Where(h => h.Estado == "Aprobado").ToList();
            }
            @if (aprobados.Any())
            {
     <div class="table-responsive">
      <table class="table table-sm">
        <thead>
     <tr>
   <th>Fecha Liberación</th>
       <th>Lote</th>
   <th>Producto</th>
    <th>Cantidad</th>
     <th>Revisado Por</th>
       </tr>
    </thead>
  <tbody>
                @foreach (var rev in aprobados)
                {
        <tr>
            <td>@rev.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
            <td><strong>@(rev.Lote?.CodigoLote ?? "N/A")</strong></td>
            <td>@(rev.Lote?.Producto?.Nombre ?? "N/A")</td>
            <td>@(rev.Lote?.CantidadInicial ?? 0)</td>
            <td><small>@(rev.UsuarioId ?? "Sistema")</small></td>
        </tr>
                }
    </tbody>
   </table>
      </div>
            }
            else
            {
        <tr>
       <td colspan="5" class="text-center text-muted">No hay lotes aprobados</td>
     </tr>
            }
      </div>
 </div>
    </div>

    <!-- Tab Rechazados -->
    <div class="tab-pane fade" id="rechazados" role="tabpanel">
  <div class="card border-danger">
      <div class="card-header bg-danger text-white">
 <h5 class="mb-0">Lotes Rechazados</h5>
      </div>
 <div class="card-body">
            @{
                var rechazados = Model.Historial.Where(h => h.Estado == "Rechazado").ToList();
            }
            @if (rechazados.Any())
            {
    <div class="table-responsive">
        <table class="table table-sm">
      <thead>
       <tr>
        <th>Fecha Rechazo</th>
    <th>Lote</th>
     <th>Producto</th>
   <th>Motivo</th>
      <th>Revisado Por</th>
     </tr>
  </thead>
   <tbody>
                @foreach (var rev in rechazados)
                {
   <tr>
        <td>@rev.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
        <td><strong>@(rev.Lote?.CodigoLote ?? "N/A")</strong></td>
        <td>@(rev.Lote?.Producto?.Nombre ?? "N/A")</td>
        <td><small>@(rev.Observacion ?? "-")</small></td>
        <td><small>@(rev.UsuarioId ?? "Sistema")</small></td>
    </tr>
                }
      </tbody>
   </table>
  </div>
            }
            else
            {
   <tr>
    <td colspan="5" class="text-center text-muted">No hay lotes rechazados</td>
    </tr>
            }
   </div>
  </div>
    </div>

    <!-- Tab Bloqueados -->
    <div class="tab-pane fade" id="bloqueados" role="tabpanel">
  <div class="card border-dark">
     <div class="card-header bg-dark text-white">
    <h5 class="mb-0">Lotes Bloqueados (En Investigación)</h5>
  </div>
    <div class="card-body">
  <div class="alert alert-warning">
      <strong>Atención:</strong> Los lotes bloqueados requieren investigación antes de tomar una decisión final.
     </div>
            @{
                var bloqueados = Model.Historial.Where(h => h.Estado == "Bloqueado").ToList();
            }
            @if (bloqueados.Any())
            {
      <div class="table-responsive">
   <table class="table table-sm">
    <thead>
   <tr>
       <th>Fecha Bloqueo</th>
     <th>Lote</th>
     <th>Producto</th>
    <th>Motivo</th>
      <th>Días Bloqueado</th>
  </tr>
    </thead>
     <tbody>
                @foreach (var rev in bloqueados)
                {
                    var diasBloqueado = (DateTime.UtcNow - rev.Fecha).Days;
 <tr>
        <td>@rev.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
        <td><strong>@(rev.Lote?.CodigoLote ?? "N/A")</strong></td>
        <td>@(rev.Lote?.Producto?.Nombre ?? "N/A")</td>
        <td><small>@(rev.Observacion ?? "-")</small></td>
        <td><span class="badge bg-danger">@diasBloqueado día(s)</span></td>
      </tr>
                }
    </tbody>
      </table>
   </div>
            }
            else
            {
 <tr>
      <td colspan="5" class="text-center text-muted">No hay lotes bloqueados</td>
      </tr>
            }
   </div>
  </div>
    </div>
</div>

@section Scripts {
    <script>
  // Mantener tab activo después de filtrar
        document.addEventListener('DOMContentLoaded', function() {
   var activeTab = localStorage.getItem('historialActiveTab');
   if (activeTab) {
       var tabButton = document.querySelector('#historialTabs button[data-bs-target="' + activeTab + '"]');
       if (tabButton) {
     var tab = new bootstrap.Tab(tabButton);
tab.show();
     }
    }

   document.querySelectorAll('#historialTabs button').forEach(function(button) {
     button.addEventListener('click', function() {
  localStorage.setItem('historialActiveTab', this.getAttribute('data-bs-target'));
       });
    });
  });
    </script>
}
