@page
@model checkpoint_web.Pages.Calidad.ControlCalidadModel
@{
 ViewData["Title"] = "Control de Calidad - Revisar Lotes";
    Layout = Request.Headers["X-Requested-With"] == "XMLHttpRequest" ? null : "/Pages/Shared/_CalidadLayout.cshtml";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Control de Calidad</h2>
    <div>
  <span class="badge bg-warning me-2">Pendientes: @Model.Estadisticas.GetValueOrDefault("LotesPendientes", 0)</span>
    <span class="badge bg-info">Aprobados: @Model.Estadisticas.GetValueOrDefault("LotesAprobados", 0)</span>
 </div>
</div>

<!-- Lotes Pendientes de Revisión -->
<div class="row">
 <div class="col-md-12">
    <div class="card">
<div class="card-header bg-warning">
       <h5 class="mb-0">Lotes en Cuarentena - Pendientes de Revisión</h5>
 </div>
     <div class="card-body">
  <div class="table-responsive">
 <table class="table table-hover">
 <thead>
    <tr>
     <th>Prioridad</th>
 <th>Código Lote</th>
  <th>Producto</th>
   <th>Fecha Ingreso</th>
    <th>Vencimiento</th>
     <th>Cantidad</th>
         <th>Temp. Ingreso</th>
    <th>Días en Cuarentena</th>
   <th>Acciones</th>
  </tr>
    </thead>
   <tbody>
        @if (Model.LotesPendientes.Any())
        {
   foreach (var lote in Model.LotesPendientes)
         {
    var diasCuarentena = (DateTime.UtcNow - lote.FechaIngreso).Days;
 var diasParaVencer = lote.FechaVencimiento.HasValue 
  ? (lote.FechaVencimiento.Value - DateTime.UtcNow).Days 
           : 999;
     var esUrgente = diasParaVencer <= 3;
         var prioridadClass = esUrgente ? "table-danger" : (diasParaVencer <= 7 ? "table-warning" : "");

              <tr class="@prioridadClass">
                <td>
              @if (esUrgente)
         {
          <span class="badge bg-danger">URGENTE</span>
    }
   else if (diasParaVencer <= 7)
        {
     <span class="badge bg-warning text-dark">PRÓXIMO</span>
          }
      else
           {
      <span class="badge bg-secondary">NORMAL</span>
   }
         </td>
               <td><strong>@lote.CodigoLote</strong></td>
 <td>@lote.Producto?.Nombre</td>
   <td>@lote.FechaIngreso.ToString("dd/MM/yyyy")</td>
          <td>
        @if (lote.FechaVencimiento.HasValue)
            {
          <span class="@(esUrgente ? "text-danger fw-bold" : "")">
             @lote.FechaVencimiento.Value.ToString("dd/MM/yyyy")
   </span>
             }
                  else
           {
      <span class="text-muted">Sin vencimiento</span>
   }
  </td>
         <td>@lote.CantidadInicial</td>
 <td>@lote.TempIngreso.ToString("N1")°C</td>
         <td>
  <span class="badge @(diasCuarentena > 2 ? "bg-danger" : "bg-info")">
        @diasCuarentena día@(diasCuarentena != 1 ? "s" : "")
                  </span>
       </td>
         <td>
      <a href="/Calidad/ControlCalidad/Index?loteId=@lote.Id" class="btn btn-primary btn-sm">
      Revisar
      </a>
     </td>
     </tr>
         }
        }
        else
        {
          <tr>
         <td colspan="9" class="text-center text-muted py-4">
   <i class="bi bi-inbox" style="font-size: 2rem;"></i>
          <p class="mt-2 mb-0">No hay lotes pendientes de revisión</p>
         <small>Los lotes recién recepcionados aparecerán aquí automáticamente</small>
       </td>
 </tr>
        }
  </tbody>
 </table>
   </div>
    </div>
   </div>
    </div>
</div>

<!-- Modal para Aprobar/Rechazar/Bloquear (placeholder) -->
<div class="modal fade" id="modalRevision" tabindex="-1">
    <div class="modal-dialog modal-lg">
  <div class="modal-content">
      <div class="modal-header">
      <h5 class="modal-title">Revisión de Lote</h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
  </div>
   <div class="modal-body">
  <p><strong>Lote:</strong> <span id="loteCodigo">-</span></p>
 <p><strong>Producto:</strong> <span id="loteProducto">-</span></p>
     <hr />
   <form id="formRevision">
    <div class="mb-3">
   <label class="form-label">Decisión</label>
   <select class="form-select" name="decision" required>
     <option value="">Seleccionar...</option>
      <option value="Aprobar">✅ Aprobar para Liberación</option>
 <option value="Rechazar">❌ Rechazar Lote</option>
     <option value="Bloquear">🔒 Bloquear por Investigación</option>
     </select>
    </div>
   <div class="mb-3">
    <label class="form-label">Observaciones</label>
  <textarea class="form-control" name="observaciones" rows="3" required></textarea>
  </div>
  <button type="submit" class="btn btn-primary">Confirmar Decisión</button>
      </form>
   </div>
        </div>
    </div>
</div>

@section Scripts {
  <script>
 // Placeholder para lógica de revisión
        document.addEventListener('DOMContentLoaded', function() {
   // Lógica para abrir modal, confirmar decisiones, etc.
     console.log('Control de Calidad: Ready');
     });
    </script>
}
